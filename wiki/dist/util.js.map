{"version":3,"sources":["../src/util.js"],"names":["api","pagination","aggregatePagination","aggregate","parseContent","fetchOptions","method","mode","credentials","Object","assign","format","action","redirects","params","keys","qs","forEach","key","apiOptions","origin","apiUrl","querystring","stringify","url","headers","then","res","json","error","Error","info","results","parseResults","query","srsearch","filter","continueType","continueKey","resolution","next","previousResults","pageLimit","list","prefix","map","e","continue","continueWith","nextFromKey","nextResults","headingPattern","getHeadings","exec","text","matches","push","level","match","trim","length","start","index","end","source","Math","min","headings","substring","heading","title","minLevel","id","content","items","lastParentLevel","sections","i","section","parent","findSection","find","s","root"],"mappings":"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","file":"util.js","sourcesContent":["import fetch from 'cross-fetch';\r\nimport querystring from 'querystring';\r\n\r\nconst fetchOptions = {\r\n\tmethod: 'GET',\r\n\tmode: 'cors',\r\n\tcredentials: 'omit'\r\n};\r\n\r\nexport function api(apiOptions, params = {}) {\r\n\tconst qs = Object.assign(\r\n\t\t{\r\n\t\t\tformat: 'json',\r\n\t\t\taction: 'query',\r\n\t\t\tredirects: ''\r\n\t\t},\r\n\t\tparams\r\n\t);\r\n\t// Remove undefined properties\r\n\tObject.keys(qs).forEach(key => {\r\n\t\tif (qs[key] === undefined) {\r\n\t\t\tdelete qs[key];\r\n\t\t}\r\n\t});\r\n\tif (apiOptions.origin) {\r\n\t\tqs.origin = apiOptions.origin;\r\n\t}\r\n\tconst url = `${apiOptions.apiUrl}?${querystring.stringify(qs)}`;\r\n\treturn fetch(\r\n\t\turl,\r\n\t\tObject.assign({ headers: apiOptions.headers }, fetchOptions)\r\n\t)\r\n\t\t.then(res => res.json())\r\n\t\t.then(res => {\r\n\t\t\tif (res.error) {\r\n\t\t\t\tthrow new Error(res.error.info);\r\n\t\t\t}\r\n\t\t\treturn res;\r\n\t\t});\r\n}\r\n\r\nexport function pagination(apiOptions, params, parseResults) {\r\n\treturn api(apiOptions, params).then(res => {\r\n\t\tlet resolution = {};\r\n\t\tresolution.results = parseResults(res);\r\n\t\tresolution.query = params.srsearch;\r\n\t\tif (res['continue']) {\r\n\t\t\tconst continueType = Object.keys(res['continue']).filter(\r\n\t\t\t\tkey => key !== 'continue'\r\n\t\t\t)[0];\r\n\t\t\tconst continueKey = res['continue'][continueType];\r\n\t\t\tparams[continueType] = continueKey;\r\n\t\t\tresolution.next = () => pagination(apiOptions, params, parseResults);\r\n\t\t}\r\n\t\treturn resolution;\r\n\t});\r\n}\r\n\r\nexport function aggregatePagination(pagination, previousResults = []) {\r\n\treturn pagination.then(res => {\r\n\t\tconst results = [...previousResults, ...res.results];\r\n\t\tif (res.next) {\r\n\t\t\treturn aggregatePagination(res.next(), results);\r\n\t\t} else {\r\n\t\t\treturn results;\r\n\t\t}\r\n\t});\r\n}\r\n\r\nconst pageLimit = 500;\r\n\r\nexport function aggregate(apiOptions, params, list, key, prefix, results = []) {\r\n\tparams.list = list;\r\n\tparams[prefix + 'limit'] = pageLimit;\r\n\treturn api(apiOptions, params).then(res => {\r\n\t\tconst nextResults = [...results, ...res.query[list].map(e => e[key])];\r\n\t\tconst continueWith = res['query-continue'] || res.continue;\r\n\t\tif (continueWith) {\r\n\t\t\tconst nextFromKey =\r\n\t\t\t\t(continueWith[list] && continueWith[list][prefix + 'from']) ||\r\n\t\t\t\tcontinueWith[prefix + 'continue'];\r\n\t\t\tparams[prefix + 'continue'] = nextFromKey;\r\n\t\t\tparams[prefix + 'from'] = nextFromKey;\r\n\t\t\treturn aggregate(apiOptions, params, list, key, prefix, nextResults);\r\n\t\t}\r\n\t\treturn nextResults;\r\n\t});\r\n}\r\n\r\nconst headingPattern = /(==+)(?:(?!\\n)\\s?)((?:(?!==|\\n)[^])+)(?:(?!\\n)\\s?)(==+)/g;\r\n\r\nfunction getHeadings(text) {\r\n\tlet match;\r\n\tconst matches = [];\r\n\twhile ((match = headingPattern.exec(text)) !== null) {\r\n\t\tmatches.push({\r\n\t\t\tlevel: match[1].trim().length,\r\n\t\t\ttext: match[2].trim(),\r\n\t\t\tstart: match.index,\r\n\t\t\tend: match.index + match[0].length\r\n\t\t});\r\n\t}\r\n\treturn matches;\r\n}\r\n\r\nexport function parseContent(source) {\r\n\tconst headings = getHeadings(source);\r\n\r\n\tconst minLevel = Math.min(...headings.map(({ level }) => level));\r\n\r\n\tconst sections = headings.map((heading, index) => {\r\n\t\tconst next = headings[index + 1];\r\n\t\tconst content = source\r\n\t\t\t.substring(heading.end, next ? next.start : undefined)\r\n\t\t\t.trim();\r\n\t\treturn {\r\n\t\t\ttitle: heading.text,\r\n\t\t\tlevel: heading.level - minLevel,\r\n\t\t\tid: index,\r\n\t\t\tcontent,\r\n\t\t\titems: []\r\n\t\t};\r\n\t});\r\n\r\n\tconst lastParentLevel = (index, level) => {\r\n\t\tif (level === 0) return null;\r\n\t\tfor (let i = index - 1; i >= 0; i--) {\r\n\t\t\tif (sections[i].level < level) {\r\n\t\t\t\treturn sections[i].id;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t};\r\n\r\n\t// Set parents\r\n\tsections.forEach((section, index) => {\r\n\t\tsection.parent = lastParentLevel(index, section.level);\r\n\t});\r\n\r\n\tconst root = {\r\n\t\titems: []\r\n\t};\r\n\r\n\tconst findSection = id => sections.find(s => id === s.id);\r\n\r\n\t// Organize\r\n\tsections.forEach(section => {\r\n\t\tif (section.parent === null) {\r\n\t\t\troot.items.push(section);\r\n\t\t} else {\r\n\t\t\tfindSection(section.parent).items.push(section);\r\n\t\t}\r\n\t});\r\n\r\n\t// Clean up\r\n\tsections.forEach(section => {\r\n\t\tdelete section.id;\r\n\t\tdelete section.parent;\r\n\t\tdelete section.level;\r\n\t\tif (!section.items.length) {\r\n\t\t\tdelete section.items;\r\n\t\t}\r\n\t});\r\n\r\n\treturn root.items;\r\n}\r\n"]}